@page "/profile"
@using NeonGadgetStore.Web.Services
@inject AuthStateService AuthService
@inject ToastService ToastService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Profile - ElectroHub</PageTitle>

<div class="min-h-screen pt-24 pb-20">
    <div class="container mx-auto px-4">
        @if (!AuthService.IsAuthenticated)
        {
            <div class="text-center py-20">
                <svg class="w-32 h-32 mx-auto text-muted-foreground/30 mb-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <h2 class="text-2xl font-semibold mb-4">Please sign in</h2>
                <p class="text-muted-foreground mb-8">You need to be logged in to view your profile.</p>
                <a href="/auth" class="btn btn-primary btn-lg rounded-xl">
                    Sign In
                </a>
            </div>
        }
        else
        {
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold mb-8">My Profile</h1>

                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Sidebar -->
                    <div class="md:col-span-1">
                        <div class="bg-card rounded-2xl border border-border p-6 text-center">
                            <div class="w-24 h-24 mx-auto rounded-full bg-primary/10 flex items-center justify-center mb-4">
                                <span class="text-4xl font-bold text-primary">
                                    @(AuthService.CurrentUser?.Email?.Substring(0, 1).ToUpper() ?? "U")
                                </span>
                            </div>
                            <h2 class="text-xl font-semibold mb-1">@(AuthService.CurrentUser?.Profile?.FullName ?? "User")</h2>
                            <p class="text-sm text-muted-foreground mb-6">@AuthService.CurrentUser?.Email</p>
                            
                            <nav class="space-y-2 text-left">
                                <button @onclick="() => activeTab = 0" 
                                        class="@GetTabClass(0) w-full px-4 py-3 rounded-xl text-left transition-colors">
                                    <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    Account
                                </button>
                                <a href="/orders" class="hover:bg-secondary block px-4 py-3 rounded-xl transition-colors">
                                    <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                    </svg>
                                    Orders
                                </a>
                                <a href="/wishlist" class="hover:bg-secondary block px-4 py-3 rounded-xl transition-colors">
                                    <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                    </svg>
                                    Wishlist
                                </a>
                                <button @onclick="() => activeTab = 1" 
                                        class="@GetTabClass(1) w-full px-4 py-3 rounded-xl text-left transition-colors">
                                    <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    Settings
                                </button>
                            </nav>

                            <button @onclick="HandleLogout" 
                                    class="w-full mt-6 px-4 py-3 text-destructive hover:bg-destructive/10 rounded-xl transition-colors text-left">
                                <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="md:col-span-2">
                        @if (activeTab == 0)
                        {
                            <!-- Account Tab -->
                            <div class="bg-card rounded-2xl border border-border p-6">
                                <h2 class="text-xl font-bold mb-6">Account Information</h2>
                                
                                <form @onsubmit="HandleSaveProfile" @onsubmit:preventDefault>
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Full Name</label>
                                            <input type="text" 
                                                   @bind="fullName"
                                                   class="form-input w-full px-4 py-3 rounded-xl bg-secondary border border-border" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Email</label>
                                            <input type="email" 
                                                   value="@AuthService.CurrentUser?.Email"
                                                   disabled
                                                   class="form-input w-full px-4 py-3 rounded-xl bg-secondary border border-border opacity-60" />
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Phone Number</label>
                                        <input type="tel" 
                                               @bind="phone"
                                               placeholder="+1 (555) 123-4567"
                                               class="form-input w-full px-4 py-3 rounded-xl bg-secondary border border-border" />
                                    </div>

                                    <div class="mb-6">
                                        <label class="block text-sm font-medium mb-2">Address</label>
                                        <textarea @bind="address"
                                                  rows="3"
                                                  placeholder="Enter your shipping address"
                                                  class="form-input w-full px-4 py-3 rounded-xl bg-secondary border border-border resize-none"></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary rounded-xl">
                                        Save Changes
                                    </button>
                                </form>
                            </div>
                        }
                        else if (activeTab == 1)
                        {
                            <!-- Settings Tab -->
                            <div class="bg-card rounded-2xl border border-border p-6">
                                <h2 class="text-xl font-bold mb-6">Settings</h2>
                                
                                <div class="space-y-6">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-medium">Email Notifications</h3>
                                            <p class="text-sm text-muted-foreground">Receive order updates via email</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" @bind="emailNotifications" class="sr-only peer">
                                            <div class="w-11 h-6 bg-secondary rounded-full peer peer-checked:bg-primary peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                        </label>
                                    </div>

                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-medium">Push Notifications</h3>
                                            <p class="text-sm text-muted-foreground">Receive push notifications on your device</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" @bind="pushNotifications" class="sr-only peer">
                                            <div class="w-11 h-6 bg-secondary rounded-full peer peer-checked:bg-primary peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                        </label>
                                    </div>

                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-medium">Marketing Emails</h3>
                                            <p class="text-sm text-muted-foreground">Receive promotional offers and newsletters</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" @bind="marketingEmails" class="sr-only peer">
                                            <div class="w-11 h-6 bg-secondary rounded-full peer peer-checked:bg-primary peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                        </label>
                                    </div>

                                    <hr class="border-border" />

                                    <div>
                                        <h3 class="font-medium text-destructive mb-2">Danger Zone</h3>
                                        <p class="text-sm text-muted-foreground mb-4">Once you delete your account, there is no going back.</p>
                                        <button type="button" class="btn btn-outline text-destructive border-destructive hover:bg-destructive hover:text-white rounded-xl">
                                            Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<Footer />

@code {
    private int activeTab = 0;
    private string fullName = "";
    private string phone = "";
    private string address = "";
    private bool emailNotifications = true;
    private bool pushNotifications = false;
    private bool marketingEmails = false;

    protected override void OnInitialized()
    {
        AuthService.OnChange += StateHasChanged;
        
        if (AuthService.CurrentUser?.Profile != null)
        {
            fullName = AuthService.CurrentUser.Profile.FullName ?? "";
            phone = AuthService.CurrentUser.Profile.Phone ?? "";
            address = AuthService.CurrentUser.Profile.Address ?? "";
        }
    }

    private string GetTabClass(int tab)
    {
        return activeTab == tab 
            ? "bg-primary/10 text-primary" 
            : "hover:bg-secondary";
    }

    private void HandleSaveProfile()
    {
        // In a real app, this would call an API
        ToastService.ShowSuccess("Profile updated successfully!");
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        ToastService.ShowInfo("You have been signed out.");
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        AuthService.OnChange -= StateHasChanged;
    }
}
